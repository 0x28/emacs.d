#+TITLE: emacs settings
* package setup
  Bootstraps use-package and sets the repositories.
  #+BEGIN_SRC emacs-lisp :results silent
    ;; set up package sources
    (require 'package)

    (setf package-archives '(("gnu" . "https://elpa.gnu.org/packages/")
                             ("melpa" . "https://melpa.org/packages/")))
    (package-initialize)

    ;; bootstrap `use-package'
    (unless (package-installed-p 'use-package)
      (package-refresh-contents)
      (package-install 'use-package))
  #+END_SRC

* company
  Generic settings for the completion framework company.
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package company
      :ensure t
      :config
      (add-hook 'after-init-hook #'global-company-mode)
      (setf company-idle-delay 0.1)
      (setf company-minimum-prefix-length 1))
  #+END_SRC

* helm
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package helm
      :ensure t
      :bind* (("M-x" . helm-M-x)
              ("C-x C-f" . helm-find-files)
              ("C-c f" . helm-occur)
              ("C-c d" . helm-semantic-or-imenu)
              ("C-c r" . helm-recentf)
              ("C-c k" . helm-show-kill-ring))
      :config
      (setq helm-net-prefer-curl t)
      (helm-mode 1)
      (define-key helm-find-files-map "\t" 'helm-execute-persistent-action))

    (use-package helm-gtags
      :ensure t
      :defer 2
      :config
      (setf helm-gtags-maximum-candidates 1000)
      (define-key evil-normal-state-map (kbd "SPC t s") #'helm-gtags-select))
  #+END_SRC

* evil
  Vim emulation for emacs.
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package evil
      :ensure t
      :init
      (setf evil-want-integration nil)
      :bind*
      (:map evil-normal-state-map
            ("SPC SPC" . helm-M-x)
            ("SPC e i" . edit-init-file)
            ("SPC q n" . save-buffers-kill-emacs)
            ("SPC f a" . helm-for-files)
            ("SPC f f" . helm-find-files)
            ("SPC f r" . helm-recentf)
            ("SPC f l" . helm-locate)
            ("SPC f d" . dired-jump)
            ("SPC n d" . narrow-to-defun)
            ("SPC n w" . widen)
            ("SPC n p" . narrow-to-paragraph)
            ("SPC w g" . helm-google-suggest)
            ("SPC w w" . helm-wikipedia-suggest))
      (:map evil-visual-state-map
            ("SPC n r" . narrow-to-region))
      :config
      ;; define "SPC v" as alias for "C-x v"
      (define-key evil-normal-state-map (kbd "SPC v")
        (lookup-key (current-global-map) (kbd "C-x v")))

      (evil-define-key 'normal org-mode-map (kbd "<tab>") #'org-cycle)

      (setq evil-normal-state-tag
            (propertize " {N} " 'face '((:foreground "green")))
            evil-emacs-state-tag
            (propertize " {E} " 'face '((:foreground "orange")))
            evil-insert-state-tag
            (propertize " {I} " 'face '((:foreground "red")))
            evil-motion-state-tag
            (propertize " {M} " 'face '((:foreground "deep sky blue")))
            evil-visual-state-tag
            (propertize " {V} " 'face '((:foreground "grey80")))
            evil-replace-state-tag
            (propertize " {R} " 'face '((:foreground "yellow")))
            evil-operator-state-tag
            (propertize " {O} " 'face '((:foreground "purple"))))

      (evil-mode))

    (use-package evil-collection
      :ensure t
      :defer 1
      :config (evil-collection-init))

    (use-package evil-mc
      :ensure t
      :config
      (global-evil-mc-mode 1))
  #+END_SRC

* ace-jump
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package ace-jump-mode
      :ensure t
      :defer 2
      :bind* (:map evil-normal-state-map
                   ("SPC j" . ace-jump-word-mode)))
  #+END_SRC

* which key
  #+BEGIN_SRC emacs-lisp :results silent
    ;; show keybindings while typing
    (use-package which-key
      :ensure t
      :defer 1
      :config
      (which-key-mode)
      (setf which-key-idle-delay 0.5))
  #+END_SRC

* flycheck
  #+BEGIN_SRC emacs-lisp :results silent
    ;; syntax checking
    (use-package flycheck
      :ensure t
      :defer 2
      :config
      (global-flycheck-mode t))
  #+END_SRC

* yasnippet
  #+BEGIN_SRC emacs-lisp :results silent
    ;; snippet completion
    (use-package yasnippet
      :ensure t
      :defer t
      :bind* ("C-c y" . yas-insert-snippet)
      :config
      (yas-global-mode 1))
  #+END_SRC
  Also load the snippets.
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package yasnippet-snippets
      :ensure t
      :defer t)
  #+END_SRC

* smartparens
  #+BEGIN_SRC emacs-lisp :results silent
    ;; better bracket handling
    (use-package smartparens
      :ensure t
      :bind*
      (:map evil-normal-state-map
            ("SPC s s" . sp-split-sexp))
      :config
      (require 'smartparens-config)
      :init
      (smartparens-global-mode 1))
  #+END_SRC

* theme
  #+BEGIN_SRC emacs-lisp :results silent
    ;; theme settings
    (use-package darktooth-theme
      :ensure t
      :config
      (defvar theme-already-loaded nil)
      (push (lambda (frame)
              (unless theme-already-loaded
                (setq theme-already-loaded t)
                (with-selected-frame frame
                  (load-theme 'darktooth t))))
            after-make-frame-functions))
  #+END_SRC

* eshell
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package eshell
      :ensure t
      :bind* (("C-c s" . toggle-eshell))
      :config
      (evil-set-initial-state 'eshell-mode 'emacs)
      (setf eshell-scroll-to-bottom-on-input t)
      (add-hook 'eshell-mode-hook (lambda ()
                                    (setq-local scroll-margin 0)
                                    (setq-local global-hl-line-mode nil)
                                    (setq-local company-idle-delay nil)))
      (setf eshell-cmpl-ignore-case t))

    (defun toggle-eshell ()
      "Open a new eshell window or switch to an existing one."
      (interactive)
      (let* ((eshell-buffer-name "*eshell*")
             (eshell-window (get-buffer-window eshell-buffer-name))
             (current-directory default-directory)
             (cd-to-default-dir (lambda ()
                                  (unless (string= default-directory
                                                   current-directory)
                                    (eshell/cd current-directory)
                                    (eshell-reset)))))
        (cond ((eq (selected-window) eshell-window)
               (delete-window))
              ((window-live-p eshell-window)
               (select-window eshell-window)
               (funcall cd-to-default-dir))
              (t
               (select-window
                (split-window (frame-root-window)
                              (round (* (window-height (frame-root-window))
                                        0.6666))
                              'below))
               (eshell)
               (funcall cd-to-default-dir)))))

  #+END_SRC

* whitespace
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package whitespace
      :ensure t
      :config
      (add-hook 'prog-mode-hook #'whitespace-mode)
      (setq-default
       fill-column 80
       whitespace-line-column fill-column
       whitespace-style '(face trailing lines-tail)))
  #+END_SRC

* C/C++ config
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package clang-format
      :ensure t
      :defer t)

    (use-package cc-mode
      :bind* (:map c-mode-map
              ("C-c i" . clang-format-buffer)
              ("C-c C-c" . comment-dwim))
      :bind* (:map c++-mode-map
              ("C-c i" . clang-format-buffer)
              ("C-c C-c" . comment-dwim))
      :config
      (add-hook 'c++-mode-hook
                (lambda () (setf flycheck-gcc-language-standard "c++11"
                                 flycheck-clang-language-standard "c++11"))))

    (setq-default c-basic-offset 4)

    (use-package cmake-mode
      :ensure t
      :config
      (setq cmake-tab-width 4))
  #+END_SRC

* LaTeX config
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package tex-site
      :ensure auctex
      :hook (LaTeX-mode . TeX-source-correlate-mode)
      :defer t
      :config
      (setenv "XLIB_SKIP_ARGB_VISUALS" nil)
      (setf font-latex-fontify-sectioning 1.0)
      (setq-default TeX-view-program-selection
                    (quote (((output-dvi has-no-display-manager) "dvi2tty")
                            ((output-dvi style-pstricks) "dvips and gv")
                            (output-pdf "Okular")
                            (output-dvi "xdvi")
                            (output-pdf "Evince")
                            (output-html "xdg-open")))))
  #+END_SRC
  Align the equal signs in bibtex
  #+BEGIN_SRC emacs-lisp :results silent
    (use-package bibtex
      :ensure t
      :defer t
      :config
      (setf bibtex-align-at-equal-sign t))
  #+END_SRC

* bookmarks
  Some bookmark keybindings.
  #+BEGIN_SRC emacs-lisp :results silent
  (use-package bookmark
    :ensure t
    :bind* (:map evil-normal-state-map
                 ("SPC b l" . list-bookmarks)
                 ("SPC b s" . bookmark-set)
                 ("SPC b j" . bookmark-jump)))
  #+END_SRC
* projectile
#+BEGIN_SRC emacs-lisp :results silent
  (use-package projectile
    :ensure t
    :defer 2
    :config
    (projectile-global-mode)

    (setq projectile-completion-system 'helm)
    (setq projectile-svn-command "find . -name .svn -prune -o -type f -print0")
    ;; define "SPC p" as additional prefix for projectile
    (define-key evil-normal-state-map (kbd "SPC p") 'projectile-command-map))
#+END_SRC

* sane defaults
  #+BEGIN_SRC emacs-lisp :results silent
    ;; don't show a startup message
    (setf inhibit-startup-message t)

    ;; no menu-bar
    (menu-bar-mode -1)

    ;; no tool-bar
    (tool-bar-mode -1)

    ;; highlight the current line
    (global-hl-line-mode)

    ;; ask "(y/n)?" and not "(yes/no)?"
    (fset #'yes-or-no-p #'y-or-n-p)

    ;; more information on describe-key
    (define-key (current-global-map) (kbd "C-h c") #'describe-key)

    ;; no blinking cursor
    (blink-cursor-mode -1)

    ;; no scroll bar
    (scroll-bar-mode -1)

    ;; start emacs maximized
    (add-to-list 'default-frame-alist '(fullscreen . maximized))

    ;; use hack font
    (add-to-list 'default-frame-alist
    '(font . "Hack-13"))

    ;; column numbers
    (column-number-mode 1)

    ;; save backups in .emacs.d
    (setf backup-directory-alist '(("." . "~/.emacs.d/.saves")))

    ;; no tabs
    (setq-default indent-tabs-mode nil)

    ;; update files when they change on disk
    (global-auto-revert-mode 1)

    ;; save more recent files
    (setf recentf-max-saved-items 100)

    ;; ask before killing emacs
    (setf confirm-kill-emacs #'y-or-n-p)

    ;; show parentheses
    (show-paren-mode)

    ;; automatically go to the help window
    (setf help-window-select t)

    ;; smoother scrolling
    (setf scroll-conservatively most-positive-fixnum)

    ;; add a margin when scrolling vertically
    (setf scroll-margin 3)

    ;; resize windows proportionally
    (setf window-combination-resize t)

    ;; sentences have a single space at the end
    (setf sentence-end-double-space nil)

    ;; no garbage collection in minibuffer
    (defun gc-minibuffer-setup-hook ()
      (setf gc-cons-threshold most-positive-fixnum))

    (defun gc-minibuffer-exit-hook ()
      (setf gc-cons-threshold 800000))

    (add-hook 'minibuffer-setup-hook #'gc-minibuffer-setup-hook)
    (add-hook 'minibuffer-exit-hook #'gc-minibuffer-exit-hook)

    ;; typed text replaces the selected text
    (delete-selection-mode 1)

    ;; hide minor-modes in mode-line
    (setf mode-line-modes '(:eval (propertize " [%m]"
                                              'face 'font-lock-constant-face)))
  #+END_SRC

* more keybindings
  Small functions used in the keybindings.
  #+BEGIN_SRC emacs-lisp :results silent
    (defun edit-init-file ()
      "Open the init file."
      (interactive)
      (find-file (expand-file-name "settings.org" user-emacs-directory)))

    (defun indent-buffer ()
      "Indent the current buffer."
      (interactive)
      (save-excursion
        (delete-trailing-whitespace)
        (unless (string-match (rx string-start
                                  "makefile"
                                  (* anything)
                                  "mode"
                                  string-end)
                              (symbol-name major-mode))
          (indent-region (point-min) (point-max) nil)
          (untabify (point-min) (point-max)))))

    ;; from https://gist.github.com/3402786
    (defun toggle-maximize-buffer ()
      "Maximize buffer"
      (interactive)
      (if (and (= 1 (length (window-list)))
               (assoc ?_ register-alist))
          (jump-to-register ?_)
        (progn
          (window-configuration-to-register ?_)
          (delete-other-windows))))

    (defun narrow-to-paragraph ()
      "Narrow to the paragraph at point."
      (interactive)
      (save-mark-and-excursion
        (mark-paragraph)
        (narrow-to-region (point)
                          (mark))))
  #+END_SRC

  Emacs C-x and C-c keybindings.
  #+BEGIN_SRC emacs-lisp :results silent

    (defun kill-current-buffer (prefix-arg)
      "Kill the current buffer."
      (interactive "P")
      (kill-buffer (current-buffer)))

    (global-set-key (kbd "C-x 1") #'toggle-maximize-buffer)
    (global-set-key (kbd "C-c i") #'indent-buffer)
    (global-set-key (kbd "C-x k") #'kill-current-buffer)
    (global-set-key (kbd "C-c m") #'man)
    (global-set-key (kbd "C-x C-b") (lambda ()
                                      (interactive)
                                      (ibuffer t)))
  #+END_SRC
